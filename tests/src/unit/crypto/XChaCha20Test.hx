package unit.crypto;

import unit.Test;
import haxe.Timer;
import haxe.io.Bytes;
import haxe.crypto.XChaCha20;

class XChaCha20Test extends Test {
	var keys = [
		"79C99798AC67300BBB2704C95C341E3245F3DCB21761B98E52FF45B24F304FC4",
		"DDF7784FEE099612C40700862189D0397FCC4CC4B3CC02B5456B3A97D1186173",
		"3D12800E7B014E88D68A73F0A95B04B435719936FEBA60473F02A9E61AE60682",
		"5F5763FF9A30C95DA5C9F2A8DFD7CC6EFD9DFB431812C075AA3E4F32E04F53E4",
		"EADC0E27F77113B5241F8CA9D6F9A5E7F09EEE68D8A5CF30700563BF01060B4E",
		"91319C9545C7C804BA6B712E22294C386FE31C4FF3D278827637B959D3DBAAB2",
		"6A6D3F412FC86C4450FC31F89F64ED46BAA3256FFCF8616E8C23A06C422842B6",
		"D45E56368EBC7BA9BE7C55CFD2DA0FEB633C1D86CAB67CD5627514FD20C2B391",
		"AFACE41A64A9A40CBC604D42BD363523BD762EB717F3E08FE2E0B4611EB4DCF3",
		"9D23BD4149CB979CCF3C5C94DD217E9808CB0E50CD0F67812235EAAF601D6232",
		"808182838485868788898A8B8C8D8E8F909192939495969798999A9B9C9D9E9F"
	];

	var nonces = [
		"B33FFD3096479BCFBC9AEE49417688A0A2554F8D95389419",
		"A9A04491E7BF00C3CA91AC7C2D38A777D88993A7047DFCC4",
		"56BED2599EAC99FB27EBF4FFCB770A64772DEC4D5849EA2D",
		"A5FA890EFA3B9A034D377926CE0E08EE6D7FACCAEE41B771",
		"A171A4EF3FDE7C4794C5B86170DC5A099B478F1B852F7B64",
		"410E854B2A911F174AAF1A56540FC3855851F41C65967A4E",
		"6B7773FCE3C2546A5DB4829F53A9165F41B08FAAE2FB72D5",
		"FD37DA2DB31E0C738754463EDADC7DAFB0833BD45DA497FC",
		"6906E0383B895AB9F1CF3803F42F27C79AD47B681C552C63",
		"C047548266B7C370D33566A2425CBF30D82D1EAF5294109E",
		"404142434445464748494A4B4C4D4E4F5051525354555658"
	];

	var plainText = [
		"0000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000",
		"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000",
		"0000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"5468652064686F6C65202870726F6E6F756E6365642022646F6C65222920697320616C736F206B6E6F776E2061732074686520417369617469632077696C6420646F672C2072656420646F672C20616E642077686973746C696E6720646F672E2049742069732061626F7574207468652073697A65206F662061204765726D616E20736865706865726420627574206C6F6F6B73206D6F7265206C696B652061206C6F6E672D6C656767656420666F782E205468697320686967686C7920656C757369766520616E6420736B696C6C6564206A756D70657220697320636C6173736966696564207769746820776F6C7665732C20636F796F7465732C206A61636B616C732C20616E6420666F78657320696E20746865207461786F6E6F6D69632066616D696C792043616E696461652E"
	];

	var ciphers = [
		"C6E9758160083AC604EF90E712CE6E75D7797590744E0CF060F013739C",
		"2F289D371F6F0ABC3CB60D11D9B7B29ADF6BC5AD843E8493E928448D",
		"A2C3C1406F33C054A92760A8E0666B84F84FA3A618F0",
		"8A1A5BA898BDBCFF602B1036E469A18A5E45789D0E8D9837D81A2388A52B0B6A0F51891528F424C4A7F492A8DD7BCE8BAC19FBDBE1FB379AC0",
		"23839F61795C3CDBCEE2C749A92543BAEEEA3CBB721402AA42E6CAE140447575F2916C5D71108E3B13357EAF86F060CB",
		"CBE7D24177119B7FDFA8B06EE04DADE4256BA7D35FFDA6B89F014E479FAEF6",
		"8B23E35B3CDD5F3F75525FC37960EC2B68918E8C046D8A832B9838F1546BE662E54FEB1203E2",
		"47950EFA8217E3DEC437454BD6B6A80A287E2570F0A48B3FA1EA3EB868BE3D486F6516606D85E5643BECC473B370871AB9EF8E2A728F73B92BD98E6E26EA7C8FF96EC5A9E8DE95E1EEE9300C",
		"A5FA7C0190792EE17675D52AD7570F1FB0892239C76D6E802C26B5B3544D13151E67513B8AAA1AC5AF2D7FD0D5E4216964324838",
		"A21209096594DE8C5667B1D13AD93F744106D054DF210E4782CD396FEC692D3515A20BF351EEC011A92C367888BC464C32F0807ACD6C203A247E0DB854148468E9F96BEE4CF718D68D5F637CBD5A376457788E6FAE90FC31097CFC",
		"4559ABBA4E48C16102E8BB2C05E6947F50A786DE162F9B0B7E592A9B53D0D4E98D8D6410D540A1A6375B26D80DACE4FAB52384C731ACBF16A5923C0C48D3575D4D0D2C673B666FAA731061277701093A6BF7A158A8864292A41C48E3A9B4C0DAECE0F8D98D0D7E05B37A307BBB66333164EC9E1B24EA0D6C3FFDDCEC4F68E7443056193A03C810E11344CA06D8ED8A2BFB1E8D48CFA6BC0EB4E2464B748142407C9F431AEE769960E15BA8B96890466EF2457599852385C661F752CE20F9DA0C09AB6B19DF74E76A95967446F8D0FD415E7BEE2A12A114C20EB5292AE7A349AE577820D5520A1F3FB62A17CE6A7E68FA7C79111D8860920BC048EF43FE84486CCB87C25F0AE045F0CCE1E7989A9AA220A28BDD4827E751A24A6D5C62D790A66393B93111C1A55DD7421A10184974C7C5"
	];

	public function test_xchacha20():Void {
		trace("XChaCha20 for " + keys.length + " keys");
		var time = Timer.stamp();
		for (i in 0...keys.length) {
			var key = Bytes.ofHex(keys[i]);
			var nonce = Bytes.ofHex(nonces[i]);
			var text = Bytes.ofHex(plainText[i]);
			var xchaCha = new XChaCha20();
			xchaCha.init(key, nonce);
			var enc = xchaCha.encrypt(text);
			eq(enc.toHex().toUpperCase(), ciphers[i]);
			xchaCha.reset();
			var decr = xchaCha.decrypt(enc);
			eq(decr.toHex().toUpperCase(), plainText[i]);
		}
		var key = Bytes.ofHex(keys[10]);
		var nonce = Bytes.ofHex(nonces[10]);
		var text = Bytes.ofHex(plainText[10]);
		var xchaCha = new XChaCha20();
		xchaCha.init(key, nonce, 1);
		var enc = xchaCha.encrypt(text);
		eq(enc.toHex().toUpperCase(),
			"7D0A2E6B7F7C65A236542630294E063B7AB9B555A5D5149AA21E4AE1E4FBCE87ECC8E08A8B5E350ABE622B2FFA617B202CFAD72032A3037E76FFDCDC4376EE053A190D7E46CA1DE04144850381B9CB29F051915386B8A710B8AC4D027B8B050F7CBA5854E028D564E453B8A968824173FC16488B8970CAC828F11AE53CABD20112F87107DF24EE6183D2274FE4C8B1485534EF2C5FBC1EC24BFC3663EFAA08BC047D29D25043532DB8391A8A3D776BF4372A6955827CCB0CDD4AF403A7CE4C63D595C75A43E045F0CCE1F29C8B93BD65AFC5974922F214A40B7C402CDB91AE73C0B63615CDAD0480680F16515A7ACE9D39236464328A37743FFC28F4DDB324F4D0F5BBDC270C65B1749A6EFFF1FBAA09536175CCD29FB9E6057B307320D316838A9C71F70B5B5907A66F7EA49AADC409");
		time = Timer.stamp() - time;
		trace("Finished : " + time + " seconds");
	}
}
